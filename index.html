<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
   	<title>Progeny: Communicative CA</title>
   	<script src="https://newsbubbles.github.io/progeny/rl.js"></script>
   	<script src="https://newsbubbles.github.io/progeny/kdTree.js"></script>
   	<script src="https://newsbubbles.github.io/progeny/linknodes.js"></script>
   	<script src="https://newsbubbles.github.io/progeny/pipe.js"></script>
   	<script src="https://newsbubbles.github.io/progeny/progeny.js"></script>
   	<script src="https://newsbubbles.github.io/progeny/colormap.js"></script>
   	<style type="text/css">
   		body {
   			background-color: #222;
   			margin: 0px;
   		}
   	</style>
  </head>
  <body>
  	<canvas id="world"></canvas>
  	<script type="text/javascript">
		const canvas = _.q('#world');
  		const ctx = canvas.getContext('2d');
  		const easeLoc = 0.002, easeVel = 0.3, minDist = 5, maxVel = 2;
  		const minRewardDist = 30, ratioPredator = 0.2;
  		//const deathAudio = new Audio('dead.wav');

  		window.clipcell = function(cell){
  			if (cell.data[0] < 0) cell.data[0] += canvas.width;
  			if (cell.data[1] < 0) cell.data[1] += canvas.height;
  			if (cell.data[0] > canvas.width) cell.data[0] = 0;
  			if (cell.data[1] > canvas.height) cell.data[1] = 0;
  			if (cell.data[2] > maxVel) cell.data[2] = maxVel;
  			if (cell.data[2] < -maxVel) cell.data[2] = -maxVel;
  			if (cell.data[3] > maxVel) cell.data[3] = maxVel;
  			if (cell.data[3] < -maxVel) cell.data[3] = -maxVel;
  		};
  		function locDiff(v1, v2){
  			return [v2[0] - v1[0], v2[1] - v1[1]];
  		}
  		function dist(v1, v2){
  			var d = locDiff(v1, v2);
  			return Math.sqrt(Math.abs(d[0] * d[0] + d[1] * d[1]));
  		}
  		function velDiff(v1, v2){
  			return [v2[2] - v1[2], v2[3] - v1[3]];
  		}
  		function vecMult(v, m){
  			return [v[0] * m, v[1] * m];
  		}

  		// Load World and visualize it in the Canvas
  		window.addEventListener('load', function(e){
  			//make sure canvas resizes

  			function resizeCanvas(e){
  				var el = canvas;
  				el.width = window.innerWidth;
  				el.height = window.innerHeight;
  			}
  			window.addEventListener('resize', resizeCanvas);
  			resizeCanvas(null);

  			//pipe = new Pipe()
			//console.log(pipe.steps)

  			var conf = {
  				numCells: 30,
  				dataWidth: 6,
  				dimTitles: ['x', 'y', 'vx', 'vy', 'type', 'life', 'c', 'd', 'e', 'f', 'g'],
  				initDimRange: [canvas.width, canvas.height, 0, 0, 1, 1, 80, 100, 120, 180],
  				initValues: [null, null, null, null, null, 1],
  				actions: [	/* This defines the action space the DQN outputs */
					function(cell, neighbor){
						//Do Nothing...
					},
					function(cell, neighbor){
						//Move toward neighbor
						d = locDiff(cell.data, neighbor[0]);
						e = vecMult(d, easeLoc);
						cell.data[2] += e[0];
						cell.data[3] += e[1];
					},
					function(cell, neighbor){
						//Move away from neighbor
						d = locDiff(cell.data, neighbor[0]);
						e = vecMult(d, easeLoc);
						cell.data[2] -= e[0];
						cell.data[3] -= e[1];
					},
					function(cell, neighbor){
						//Move in same direction as neighbor
						d = velDiff(cell.data, neighbor[0]);
						e = vecMult(d, easeVel);
						cell.data[2] += e[0];
						cell.data[3] += e[1];
					},
					function(cell, neighbor){
						//Move in opposite direction
						d = velDiff(cell.data, neighbor[0]);
						e = vecMult(d, easeVel);
						cell.data[2] -= e[0];
						cell.data[3] -= e[1];
					},
				],
				cellStep: function(cell){
					// This happens after cell walks through neighbors

					//use the data[2] and data[3] as velocity vector for data[0] and data[1]
					cell.data[0] += cell.data[2];
					cell.data[1] += cell.data[3];
					window.clipcell(cell);
				},
				cellReward: function(cell, neighbor){
					// Negative reward for being near neighbor if neighbor is hunter
					d = dist(cell.data, neighbor[0]);
					// Is the 
					var cp = cell.data[4] < ratioPredator, 
						np = neighbor[0][4] < ratioPredator;
					var chase = cp && !np, 
						run = !cp && np, 
						team = cp && np || !cp && !np;
					//console.log(d, minDist);
					if (d > 0 && d < minDist){
						// make the cell lose life.
						//console.log('hithit', cell.data[4], neighbor[0][4], ratioPredator, run || chase);
						if (run){
							cell.data[5] -= 0.1;
							// if prey neighbor dies, give big reward, and neg to prey
							//console.log('hit!');
							if (cell.data[5] <= 0.0){ // dead
								//console.log('DEAD!');
								cell.data[0] = Math.random() * canvas.width;
								cell.data[1] = Math.random() * canvas.height;
								cell.data[2] = 0;
								cell.data[3] = 0;
								cell.data[5] = 1.0;
								return -20.0;
							}
						}
						// give a big reward if prey is dead
						if (chase){
							if (neighbor[0][5] <= 0.1){
								console.log('KILL!');
								return 20.0;
							}
						}
						return chase ? 1.0: run ? -1.0: team && !cp ? 2.0: 0.0;
					}
					if (team && !cp && d < minRewardDist && d > 0){
						return 1.0;
					}
					/*else{
						if (d < minRewardDist){
							return chase ? 1.0: run ? -1.0: team && !cp ? 2.0: 0.0;
						}else{
							return 0.0;
						}
					}*/
				},
				interval: 0,
  				draw: function(world){
					ctx.clearRect(0, 0, canvas.width, canvas.height);
  					world.cells.forEach(function(cell, index){
  						var predator = cell.data[4] < ratioPredator;
  						var x = Math.round(cell.data[0]);
  						var y = Math.round(cell.data[1]);
  						var r = (predator ? 8: 5);
  						var rr = r * 2;
  						var ir = r * cell.data[5], irr = rr * cell.data[5];
  						ctx.fillStyle = window.colormap[index].hex;
  						ctx.strokeStyle = predator ? '#f00': '#0f0';
  						/*if (cell.neighbors.length > 0){
	  						var n = cell.neighbors[0][0];
	  						var xn = Math.round(n[0]);
	  						var yn = Math.round(n[1]);
	  						ctx.strokeStyle = ctx.fillStyle;
	  						ctx.beginPath();
	  						ctx.moveTo(x, y);
	  						ctx.lineTo(xn, yn);
	  						ctx.stroke();
	  						ctx.closePath();
	  					}*/
  						ctx.fillRect(x - ir, y - ir, irr, irr);
  						ctx.lineWidth = 1;
  						ctx.beginPath();
  						ctx.rect(x - r, y - r, rr, rr);
  						ctx.stroke();
  					});
  				},
  			};

  			// Create world from configuration
  			window.world = new World(conf);

  			// Create the cells in the world
  			window.world.generate();
  			console.log(world.cells.origNode);
  			
  			// Start the world, to stop use world.stop()
  			world.start();

  		});
  	</script>
  </body>
</html>